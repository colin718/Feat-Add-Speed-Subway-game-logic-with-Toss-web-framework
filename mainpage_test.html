<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
  /* ë”ë¸”íƒ­/í•€ì¹˜ í™•ëŒ€ ë°©ì§€ */
  html, body { touch-action: manipulation; }
</style>

<title>Speed Subway â€” ë‹¤ìŒ ì—­ ë§ì¶”ê¸°</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">

<style>
  :root{
    --bg-1:#0a0e1a;
    --bg-2:#1a1f2e;
    --panel: rgba(255,255,255,0.06);
    --muted:#8b9bb8;
    --accent:#00A84D; /* ë™ì ìœ¼ë¡œ ë°”ë€œ */
    --danger:#FF5A5A;
    --glass: rgba(255,255,255,0.08);
    --radius:20px;
    --max-width:980px;
    --shadow: 0 20px 40px rgba(0,0,0,0.3);
    --glow: 0 0 30px rgba(0,168,77,0.3);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin:0; font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',Arial;
    color:#f8faff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh;
    position:relative;

    background-image: url('background.jpg'); /* ë°°ê²½ ì´ë¯¸ì§€ ê²½ë¡œ ì§€ì • */
    background-size: cover;                  /* í™”ë©´ ë¹„ìœ¨ì— ë§ê²Œ ê½‰ ì±„ìš°ê¸° */
    background-position: center;             /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ìœ„ì¹˜ */
    background-repeat: no-repeat;            /* ì´ë¯¸ì§€ê°€ ë°˜ë³µë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
    background-color: #2e353b;               /* ì´ë¯¸ì§€ê°€ ë¡œë”©ë˜ì§€ ì•Šì„ ë•Œ ë³´ì¼ ë°°ê²½ìƒ‰ */
}

  /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
  #loadingOverlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.55); z-index:9999; transition:opacity .25s;
  }
  #loadingCard{ background:#fff; color:#001a0f; padding:18px 22px; border-radius:12px; display:flex; gap:12px; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.45); }
  .spinner{ width:36px; height:36px; border-radius:50%; border:4px solid #e6eef3; border-top-color:#00ffcc; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* container */
  .wrap {
    width: 100%;
    max-width: var(--max-width);
    position: relative;
    z-index: 2;
    padding: 20px;
  }
  
  .game-area {
    max-width: var(--max-width);  /* ìµœëŒ€ í­ ì œí•œ */
    width: 100%;
    display: flex;                /* flexbox ë ˆì´ì•„ì›ƒ ì‚¬ìš© */
    flex-direction: column;       /* ìì‹ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ìŒ“ë„ë¡ ë³€ê²½ */
    align-items: center;          /* ìì‹ ìš”ì†Œë“¤ì„ ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
    gap: 14px;                    /* ìš”ì†Œ ì‚¬ì´ì˜ ê°„ê²© ì¶”ê°€ */
  }

  .game-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
      radial-gradient(circle at 20% 20%, rgba(0,255,204,0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(0,255,204,0.03) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(0,255,204,0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: 1;
  }

  /* top right line select */
  #line-select {
    position:fixed; right:18px; top:18px; z-index:90;
    background:#fff; color:#111; padding:8px 12px; border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.45); border:0; font-weight:700;
  }

  /* ì§€í•˜ì²  íƒ€ì¼ ë²½ + ì´ˆë¡ìƒ‰ ë¼ì¸ */
  .subway-wall {
    position: relative;
    width: 100%;
    height: 100%;
    /* ë°°ê²½ ì´ë¯¸ì§€ ê´€ë ¨ ì½”ë“œë¥¼ ë‹¤ì‹œ ì œê±°í•˜ì—¬ íˆ¬ëª…í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. */
    background: transparent; /* ì´ ë¶€ë¶„ ì¶”ê°€ */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  /* ì „ê´‘íŒ */
  .billboard {
    width: 90%;
    max-width: 900px;
    height: 480px;
    background: linear-gradient(135deg, #004d26 0%, #001a0f 100%);
    border:14px solid #111;
    border-radius:6px;
    box-shadow:0 18px 40px rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
    position:relative;
    overflow:hidden;
    z-index:2; /* ë¼ì¸ ìœ„ì— ì˜¬ë¼ì˜¤ë„ë¡ */
  }

  /* ì „ê´‘íŒ ë°˜ì‚¬ê´‘ */
  .billboard::before {
    content:"";
    position:absolute;
    top:0; left:-50%;
    width:200%; height:100%;
    background:linear-gradient(120deg, rgba(255,255,255,0.15) 0%, transparent 60%);
    transform:skewX(-20deg);
    animation: shine 8s infinite;
  }

  @keyframes shine {
    0% { left:-150%; }
    50% { left:100%; }
    100% { left:150%; }
  }

  /* ì „ê´‘íŒ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
  .billboard-text {
    font-size:48px;
    font-weight:900;
    color:#fff;
    text-shadow:0 0 8px #00ffcc, 0 0 16px #00ffcc;
    z-index:2;
  }

  /* ì „ê´‘íŒ ë‚´ë¶€ ì½˜í…ì¸  */
  .billboard-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    z-index: 10;
    position: relative;
  }

  #intro {
    text-align: center;
    margin: 0 auto;
    background: transparent; /* ë°°ê²½ì„ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ ë³€ê²½ */
    padding: 40px;
    border-radius: 15px;
    box-shadow: none; /* ê·¸ë¦¼ì íš¨ê³¼ ì œê±° */
    max-width: 800px;
    width: 90%;
    color: #f8faff; 
  }

  #start-btn{
    padding:20px 56px; font-weight:800; border-radius:16px; border:0;
    background:linear-gradient(135deg,#00ffcc,#00d4a3); color:#001a0f;
    font-size:20px; cursor:pointer;
    box-shadow:0 20px 40px rgba(0,255,204,0.3), 0 0 30px rgba(0,255,204,0.2);
    transform: translateY(8px); opacity:0; animation:btnIn .5s ease forwards .9s;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  #start-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  #start-btn:hover::before {
    left: 100%;
  }

  #start-btn:hover {
    transform: translateY(-2px);
    box-shadow:0 25px 50px rgba(0,255,204,0.4), 0 0 40px rgba(0,255,204,0.3);
  }
  #start-btn:disabled{ filter:grayscale(.4) brightness(.9); cursor:not-allowed; opacity:.7; }

  @keyframes btnIn { to{ transform:none; opacity:1; } }

  /* --- Top info: timer / title --- */
  .topbar {
    width:100%; display:flex; align-items:center;gap:12px;
    max-width:var(--max-width);
    background: linear-gradient(135deg, #fff, #f8f9fa);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(0,255,204,0.3);
    border-radius: 20px;
    padding: 16px 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1), 0 0 15px rgba(0,255,204,0.1);
    position: relative;
    z-index: 2;
  }
  .title-box{ font-weight:900; font-size:22px; color:#001a0f; letter-spacing:0.2px; text-shadow:0 2px 4px rgba(0,0,0,0.3);}
  .timer-box{ text-align:right; margin-left: auto;}
  .timer { font-weight:900; font-size:32px; color:#050505;}
  .best { color:#666; font-size:14px; margin-top:8px; font-weight:600; }

  /* --- Station row (your sketch) --- */
  .station-card {
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #fff, #f8f9fa);
    border-radius: 50px;
    padding: 14px 18px;
    gap: 16px;
    min-height: 80px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.08);
    border: 3px solid var(--accent);
    font-family: 'Noto Sans KR', sans-serif;
    flex: 0 1 auto;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }

  .station-text {
    display: flex;
    flex-direction: column;
    align-items: flex-start;

    flex: 1;
    min-width: 0;
  }

  .station-card.current .ko {
    font-size: 28px;
    font-weight: bold;
    color: #000;
  }

  .station-card.prev-card,
  .station-card.next-card {
    width: 220px; /* âœ¨ ì–‘ìª½ ì¹´ë“œ ë„ˆë¹„ (ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì ˆí•˜ì„¸ìš”) */
  }

  .station-card.current {
    width: 400px; /* âœ¨ ê°€ìš´ë° ì¹´ë“œ ë„ˆë¹„ (ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì ˆí•˜ì„¸ìš”) */
  }

  .station-text .ko {
    font-size: 28px;
    font-weight: bold;
    color: #000;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .station-text .en {
    font-size: 18px;
    font-weight: 500;
    color: #000;
  }


  .arrow {
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: 8px; /* dot ì˜¤ë¥¸ìª½ì— ìœ„ì¹˜ */
  }

  .arrow svg {
    width: 18px;
    height: 18px;
    fill: #fff;
  }

  .station-row {
    display: flex;
    justify-content: center; /* ì¢Œ-ì¤‘-ìš° ë°°ì¹˜ */
    align-items: center;
    width: 100%;
    max-width: var(--max-width);
    gap: 24px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
  }

  .station-card.current {
    background: linear-gradient(135deg, #FDFBF5, #f8f6f0);
    border: 4px solid var(--accent);
    border-radius: 999px;
    padding: 14px 14px 14px 32px;
    justify-content: space-between;
    box-shadow: 0 12px 32px rgba(25,155,78,0.25), 0 6px 20px rgba(0,0,0,0.1);
    transform: scale(1.02);
    position: relative;
    z-index: 3;
  }

  /* ì˜¤ë¥¸ìª½ í™”ì‚´í‘œë¥¼ ì´ˆë¡ìƒ‰ ì¬ìƒ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ */
  .station-card.current .arrow {
    background: var(--accent);
    border-radius: 50%;
    width: 52px;
    height: 52px;
    flex-shrink: 0;
    margin-left: 16px;
    box-shadow: 0 8px 20px rgba(25,155,78,0.3), 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .station-card.current .arrow:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 28px rgba(25,155,78,0.4), 0 6px 16px rgba(0,0,0,0.3);
  }

  /* ë²„íŠ¼ ì•ˆì˜ ì•„ì´ì½˜(SVG) ìƒ‰ìƒê³¼ í¬ê¸° ì¡°ì • */
  .station-card.current .arrow svg {
    fill: #fff; /* ì•„ì´ì½˜ í°ìƒ‰ìœ¼ë¡œ */
    width: 20px;
    height: 20px;
  }

  /* ì›€ì§ì´ëŠ” ì§€í•˜ì²  ìŠ¤íƒ€ì¼ ë° ì• ë‹ˆë©”ì´ì…˜ */
  #animatedTrain {
    position: absolute; /* ë¶€ëª¨ ìš”ì†Œ(.subway-wall) ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³ ì • */
    bottom: -880px;
    left: 200%;
    width: 2200px;
    z-index: 15; /* billboard(z-index:2)ë³´ë‹¤ ë’¤ì— ìœ„ì¹˜ */
    
    animation: slideInAndStop 22s ease-in-out infinite;
  }
    /* ì• ë‹ˆë©”ì´ì…˜ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ (ì—†ë‹¤ë©´ ì¶”ê°€) */
  .animation-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* í´ë¦­ ë°©ì§€ */
    z-index: 5; /* ì „ê´‘íŒ(billboard)ê³¼ ë°°ê²½ ì‚¬ì´ ì ì ˆí•œ ìœ„ì¹˜ */
  }

  #waitingPerson1, #waitingPerson2 {
    position: absolute;
    width: 60px;
    height: 150px;
    z-index: 3;
    top: 425px;
    /* left: 50%ë¥¼ ê³µí†µ ìŠ¤íƒ€ì¼ì—ì„œ ì œê±°í•©ë‹ˆë‹¤. */
  }
  
  #waitingPerson1 {
    /* ì´ì œ ê³ ì •ëœ ë„ˆë¹„(800px)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ê°€ ê³„ì‚°ë©ë‹ˆë‹¤. */
    left: 200px; 
  }
  
  #waitingPerson2 {
    /* ì˜¤ë¥¸ìª½ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ê³ ì •í•©ë‹ˆë‹¤. */
    right: 270px;
  }
  
  /* ì§€í•˜ì²  ì½”ë“œë„ position: absolute; ì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤. (í˜„ì¬ ì½”ë“œëŠ” ì˜¬ë°”ë¥´ê²Œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.) */
  #animatedTrain {
    position: absolute; /* âœ… ë¶€ëª¨(.animation-layer) ê¸°ì¤€ */
    bottom: -880px;
    left: 210%;
    width: 2200px;
    z-index: 15;
    animation: slideInAndStop 22s ease-in-out infinite;
  }

  /* ì§€í•˜ì² ì´ ë“¤ì–´ì™€ì„œ ë©ˆì¶”ëŠ” ì›€ì§ì„ ì •ì˜ */
  @keyframes slideInAndStop {
    /* --- 0% ~ 55% (ì•½ 12ì´ˆ): ê¸°ì¡´ì²˜ëŸ¼ ì—´ì°¨ê°€ ë³´ì´ê³  ì›€ì§ì´ëŠ” êµ¬ê°„ --- */
    0% {
      transform: translateX(0%); /* í™”ë©´ ì˜¤ë¥¸ìª½ ë°–ì—ì„œ ì¶œë°œ */
    }
    14% { /* (ê¸°ì¡´ 25% ì§€ì ) */
      transform: translateX(-110%); /* í™”ë©´ ì•ˆìœ¼ë¡œ ë“¤ì–´ì™€ ì •ì°¨ */
    }
    45% { /* (ê¸°ì¡´ 80% ì§€ì ) */
      transform: translateX(-110%); /* ì •ì°¨ ìƒíƒœ ìœ ì§€ */
    }
    55% { /* (ê¸°ì¡´ 100% ì§€ì ) */
      transform: translateX(-220%); /* í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ì‚¬ë¼ì§ */
    }
  
    /* --- 55% ~ 100% (ì•½ 10ì´ˆ): ì—´ì°¨ê°€ í™”ë©´ ë°–ì— ë¨¸ë¬´ë¥´ëŠ” ì§€ì—° êµ¬ê°„ --- */
    100% {
      transform: translateX(-220%); /* ì‚¬ë¼ì§„ ìœ„ì¹˜ì—ì„œ ê³„ì† ëŒ€ê¸° */
    }
  }

  /* --- Options grid like your drawing --- */
  #options {
    width:100%; max-width:var(--max-width); display:grid; gap:12px;
    grid-template-columns: repeat(4, 1fr);
  }
  /* 2x4 style on narrow screens */
  @media (max-width:900px){
    #options{ grid-template-columns:repeat(3,1fr); }
    .station-card{ flex-shrink: 0;}
  }
  @media (max-width:640px){
    #options{ grid-template-columns:repeat(2,1fr); }
    .station-card{ width:100%; }
  }

  .option {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    padding:16px; border-radius:16px; text-align:center; font-weight:800; cursor:pointer;
    box-shadow:0 6px 20px rgba(0,0,0,0.1), 0 3px 10px rgba(0,0,0,0.08); border:2px solid rgba(0,255,204,0.3);
    min-height:60px; display:flex; align-items:center; justify-content:center; user-select:none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    color: #333;
    z-index: 2;
  }

  .option::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0,255,204,0.15), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .option:hover{
    transform:translateY(-6px) scale(1.02);
    box-shadow:0 12px 28px rgba(0,0,0,0.15), 0 6px 16px rgba(0,0,0,0.1), 0 0 15px rgba(0,255,204,0.2);
    border-color: rgba(0,255,204,0.5);
  }

  .option:hover::before {
    opacity: 1;
  }

  .option:active{ transform:translateY(-4px) scale(.98); }
  .option.wrong{
    animation: shake .42s;
    border-color:var(--danger);
    box-shadow:0 8px 30px rgba(255,90,90,0.2) inset, 0 0 20px rgba(255,90,90,0.3);
  }
  .option.correct{
    background: linear-gradient(135deg, rgba(0,255,204,0.2), rgba(0,255,204,0.1));
    border-color: rgba(0,255,204,0.8);
    box-shadow: 0 8px 24px rgba(0,255,204,0.3), 0 0 15px rgba(0,255,204,0.2);
  }

  @keyframes shake { 0%,100%{transform:none} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

  /* message line */
  #msg{ color:#fff; margin-top:8px; text-align:center; font-weight:600; position: relative;z-index: 2; min-height:28px;}

  /* footer spacer */
  .spacer{ height:36px }

  /* accessibility focus */
  .option:focus { outline: 3px solid rgba(255,255,255,0.06); outline-offset:3px; }

  /* Mode selection buttons */
  .mode-select-btn {
    background: linear-gradient(135deg, rgba(0,255,204,0.1), rgba(0,255,204,0.05));
    border: 2px solid rgba(0,255,204,0.3);
    border-radius: 16px;
    padding: 16px 20px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 0 20px rgba(0,255,204,0.1);
    position: relative;
    overflow: hidden;
  }

  .mode-select-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .mode-select-btn:hover {
    background: linear-gradient(135deg, rgba(0,255,204,0.2), rgba(0,255,204,0.1));
    border-color: rgba(0,255,204,0.5);
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.4), 0 0 30px rgba(0,255,204,0.2);
  }

  .mode-select-btn:hover::before {
    opacity: 1;
  }

  .mode-select-btn.selected {
    border-color: #00ffcc;
    background: linear-gradient(135deg, rgba(0,255,204,0.3), rgba(0,255,204,0.15));
    box-shadow: 0 8px 24px rgba(0,255,204,0.4), 0 0 30px rgba(0,255,204,0.3);
  }

  .mode-select-btn.selected::before {
    opacity: 1;
    background: linear-gradient(135deg, rgba(0,168,77,0.3), transparent);
  }

  /* Line selection grid for mode 2 */
  .line-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    max-width: 450px;
    margin: 0 auto;
    max-height: 220px;
    overflow-y: auto;
    padding: 12px;
    border: 2px solid rgba(0,255,204,0.2);
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(0,255,204,0.05), rgba(0,255,204,0.02));
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 20px rgba(0,255,204,0.1);
  }

  /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
  .line-selection-grid::-webkit-scrollbar {
    width: 6px;
  }
  .line-selection-grid::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
  }
  .line-selection-grid::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
  }
  .line-selection-grid::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.3);
  }
  .line-option {
    background: linear-gradient(135deg, rgba(0,255,204,0.1), rgba(0,255,204,0.05));
    border: 2px solid rgba(0,255,204,0.2);
    border-radius: 12px;
    padding: 10px 14px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13px;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 0 10px rgba(0,255,204,0.1);
    position: relative;
    overflow: hidden;
  }

  .line-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .line-option:hover {
    border-color: rgba(0,255,204,0.4);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3), 0 0 15px rgba(0,255,204,0.2);
  }

  .line-option:hover::before {
    opacity: 1;
  }

  .line-option.selected {
    border-color: #00ffcc;
    background: linear-gradient(135deg, rgba(0,255,204,0.3), rgba(0,255,204,0.2));
    box-shadow: 0 4px 16px rgba(0,255,204,0.4), 0 0 15px rgba(0,255,204,0.3);
  }

  .line-option.selected::before {
    opacity: 1;
    background: linear-gradient(135deg, rgba(0,168,77,0.3), transparent);
  }

  /* ì„ íƒëœ ë…¸ì„  í‘œì‹œë¥¼ ìœ„í•œ CSS */
  #selected-lines-display {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    padding: 0 12px;
  }

  .selected-line-badge {
    background: rgba(0, 255, 204, 0.2);
    border: 1px solid rgba(0, 255, 204, 0.5);
    color: #00ffcc;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }
  
  .interactive-area {
    /* ê·¸ë£¹ ë‚´ë¶€ ìš”ì†Œ(ì—­ëª…íŒ, ë©”ì‹œì§€, ì„ íƒì§€)ë¥¼ ì •ë ¬í•˜ê¸° ìœ„í•œ ì½”ë“œ */
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  
    /* ìƒë‹¨ ë°”(timer)ì™€ì˜ ê°„ê²©ì„ ì£¼ì–´ ê·¸ë£¹ ì „ì²´ë¥¼ ì•„ë˜ë¡œ ì´ë™ì‹œí‚¤ëŠ” ì½”ë“œ */
    margin-top: 60px; /* âœ¨ ì´ ê°’ì„ ì¡°ì ˆí•´ì„œ ì›í•˜ëŠ” ë†’ì´ë¡œ ë§ì¶”ì„¸ìš” */
  }

  @media (max-width: 640px) {
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ì „ê´‘íŒ ë†’ì´ë¥¼ ì¡°ê¸ˆ ì¤„ì…ë‹ˆë‹¤. */
    .billboard {
      height: 380px; 
    }
  
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ì‚¬ëŒê³¼ ì§€í•˜ì²  í¬ê¸°ë¥¼ ì•½ê°„ ì¤„ì—¬ ë¹„ìœ¨ì„ ë§ì¶¥ë‹ˆë‹¤. */
    #animatedTrain {
      transform: scale(0.8);
      /* í¬ê¸°ê°€ ì‘ì•„ì¡Œìœ¼ë¯€ë¡œ ìœ„ì¹˜ë„ ë¯¸ì„¸ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. */
      bottom: -750px; 
    }
    #waitingPerson1, #waitingPerson2 {
      transform: scale(0.85); /* í¬ê¸°ë§Œ ì¤„ì´ê³  */
      bottom: -45px;
      top: auto; /* ì„¸ë¡œ ìœ„ì¹˜ ì¶©ëŒ ë°©ì§€ */
    }

    #waitingPerson1 {
        left: 20%; /* ì¢Œìš° ìœ„ì¹˜ëŠ” ì—¬ê¸°ì„œ ë‹¤ì‹œ ì§€ì •í•©ë‹ˆë‹¤. */
    }

    #waitingPerson2 {
        right: 20%; /* ì¢Œìš° ìœ„ì¹˜ëŠ” ì—¬ê¸°ì„œ ë‹¤ì‹œ ì§€ì •í•©ë‹ˆë‹¤. */
    }
  }

</style>
</head>
<body>
  <select id="line-select" aria-label="ë…¸ì„  ì„ íƒ" style="display:none;"></select>

  <div id="loadingOverlay" role="status" aria-live="polite" aria-busy="true">
    <div id="loadingCard">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadingText" style="font-weight:800;">ì—­ ë°ì´í„° ë¡œë“œ ì¤‘...</div>
    </div>
  </div>

  <div class="wrap">

    <div id="intro" role="dialog" aria-modal="true">
      <div class="animation-layer">
        <div style="position: relative; width: 100%; max-width: 800px; margin: 0 auto; height: 100%;">
        <img id="animatedTrain" src="train.png" alt="ì›€ì§ì´ëŠ” ì§€í•˜ì² ">
        <img id="waitingPerson1" src="human1.png" alt="ê¸°ë‹¤ë¦¬ëŠ” ì‚¬ëŒ">
        <img id="waitingPerson2" src="human2.png" alt="ê¸°ë‹¤ë¦¬ëŠ” ì‚¬ëŒ">
        </div>
      </div>
      <div class="subway-wall">
        <div class="billboard-content">
          <div id="mode-selection" style="margin-bottom:32px;">
            <div style="color:#fff; font-weight:800; font-size:24px; margin-bottom:20px; text-align:center; text-shadow:0 2px 4px rgba(0,0,0,0.5);">ê²Œì„ ëª¨ë“œ ì„ íƒ</div>
            <div style="display:flex; gap:20px; justify-content:center; margin-bottom:20px;">
              <button id="mode1-btn" class="mode-select-btn selected" aria-pressed="true">
                <div style="font-size:18px; font-weight:700;">íƒ€ì„ì–´íƒ</div>
                <div style="font-size:14px; color:#00ffcc; margin-top:6px;">1ë¶„ ì œí•œ</div>
              </button>
              <button id="mode2-btn" class="mode-select-btn" aria-pressed="false">
                <div style="font-size:18px; font-weight:700;">ëª©ì ì§€ ë„ë‹¬</div>
                <div style="font-size:14px; color:#00ffcc; margin-top:6px;">ì—¬ëŸ¬ ë…¸ì„ </div>
              </button>
            </div>
          </div>
          <div id="line-selection-container" style="display:none; margin-bottom:24px;">
            <div style="color:#fff; font-weight:800; font-size:20px; margin-bottom:12px; text-align:center; text-shadow:0 2px 4px rgba(0,0,0,0.5);">ë…¸ì„  ì„ íƒ</div>
            <div id="line-selection-info" style="color:#00ffcc; font-size:16px; margin-bottom:16px; text-align:center;">í”Œë ˆì´í•  ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div id="selected-lines-display" style="margin-bottom: 16px; min-height: 30px;"></div>
            <div id="line-selection-grid" class="line-selection-grid"></div>
            <div style="margin-top:20px; text-align:center;">
              <div id="button-status" style="color:#00ffcc; font-size:14px; margin-top:10px; font-weight:600;">ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>
          </div>
          <button id="start-btn" disabled>ê²Œì„ ì‹œì‘</button>
          <div id="start-info" style="color:#00ffcc; font-weight:700; margin-top:8px; text-align:center;">ë…¸ì„  ë¡œë“œê°€ ëë‚˜ë©´ ì‹œì‘ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div> <div class="game-area" style="display: none;">
      <div class="topbar" aria-hidden="false">
        <div class="title-box" id="titleBox">Speed Subway <span style="color:#00ffcc; font-weight:900; margin-left:8px;">JH</span></div>
        <div class="timer-box">
          <div class="timer" id="timer">00:00.00</div>
          <div class="best" id="bestTime">ìµœê³ ê¸°ë¡: -</div>
        </div>
      </div>
      <div class="interactive-area">
        <div class="station-row" role="region" aria-label="í˜„ì¬ì—­ í‘œì‹œ">
          <div class="station-card prev-card" id="prevCard">
            <div class="station-dot"></div>
            <div class="station-text">
              <div class="ko" id="prevName">-</div>
            </div>
            <div class="arrow">
              <svg viewBox="0 0 24 24"><path d="M8 4l8 8-8 8z"></path></svg>
            </div>
          </div>
          <div class="station-card current" id="currentCard">
            <div class="station-dot" id="curDot"></div>
            <div class="station-text">
              <div class="ko" id="currentName" aria-live="polite">-</div>
            </div>
            <div class="arrow">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
            </div>
          </div>
          <div class="station-card next-card" id="nextCard">
            <div class="station-dot"></div>
            <div class="station-text">
              <div class="ko" id="nextName">???</div>
            </div>
            <div class="arrow">
              <svg viewBox="0 0 24 24"><path d="M8 4l8 8-8 8z"></path></svg>
            </div>
          </div>
        </div>
        <div id="msg" aria-live="assertive">ë…¸ì„ ì„ ì„ íƒí•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        <div id="options" role="list"></div>
      </div>
      <div class="spacer"></div>
    </div> </div> <script>
    /* ... (ê¸°ì¡´ script ë‚´ìš©ì€ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤) ... */
  </script>
  <script type="module">
    /* ... (ê¸°ì¡´ script type="module" ë‚´ìš©ì€ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤) ... */
  </script>

  

<script>
/* ===============================
  ì „ì²´ ê¸°ëŠ¥: (ê¸°ì¡´ ì½”ë“œ ê¸°ë°˜, ì•„ë˜ í•­ëª© ë³€ê²½)
  1) ë¡œë”© ìƒíƒœ í‘œì‹œ (loadingOverlay)
  2) ë¦¬ë”ë³´ë“œ ì œì¶œ: ì§€ë‚˜ê°„ ì—­ ìˆ˜ (movedStations)
  3) íƒ€ì„ì–´íƒ ì¢…ë£Œ ì¡°ê±´ êµ¬ë¶„(íƒ€ì„ì•„ì›ƒ/ìˆœí™˜ì„  ì™„ì£¼/ì¢…ì )
  4) ì ‘ê·¼ì„± ë©”ì‹œì§€ ë‹¤ì–‘í™” (ì •ë‹µ/ì˜¤ë‹µ/ì¢…ë£Œ ë©”ì‹œì§€ ëœë¤)
  5) ë¸Œëœë“œ JH ìƒë‹¨ì— ì¶”ê°€ (HTML)
  =============================== */

const JSON_PATH = 'korean_subway_lines.json';

// DOM
const lineSelect = document.getElementById('line-select');
const intro = document.getElementById('intro');
const startBtn = document.getElementById('start-btn');
const msgEl = document.getElementById('msg');
const optionsEl = document.getElementById('options');
const mode1Btn = document.getElementById('mode1-btn');
const mode2Btn = document.getElementById('mode2-btn');
const lineSelectionContainer = document.getElementById('line-selection-container');
const lineSelectionGrid = document.getElementById('line-selection-grid');
const lineSelectionInfo = document.getElementById('line-selection-info');
const startGameBtn = document.getElementById('start-game-btn');
const buttonStatus = document.getElementById('button-status');
const startInfo = document.getElementById('start-info');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

const prevNameEl = document.getElementById('prevName');
const curNameEl = document.getElementById('currentName');
const nextNameEl = document.getElementById('nextName');

const curDot = document.getElementById('curDot');
const timerEl = document.getElementById('timer');
const bestEl = document.getElementById('bestTime');
const titleBox = document.getElementById('titleBox');

// game state
let subwayData = {};
let currentLine = [];
let regionName = '', lineName = '';
let currentIndex = 0;
let started = false;
let startTs = 0;
let penaltyMs = 0;
let timerRaf = null;
let audioCtx = null;
let gameMode = null; // 'timeattack' or 'destination'
let selectedLines = []; // for mode 2
let destinationStation = null; // for mode 2
let timeLimit = 60000; // 1ë¶„ for mode 1

// ìˆœí™˜ì„ /ì¼ë°˜ì„  êµ¬ë¶„, ì‹œì‘ ì¸ë±ìŠ¤
let startStationIndex = 0;
let isLoopLine = false;

// íŠ¸ë˜í‚¹: ì§€ë‚˜ê°„ ì—­ ìˆ˜ (leaderboard ì œì¶œê°’)
window.movedStations = 0; // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (module ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
let movedStations = 0;

// ë¡œë”© / íƒ€ì„ë¦¬ë°‹ íƒ€ì´ë¨¸
let isDataLoaded = false;
let timeLimitTimer = null;
let finishReason = null; // 'timeout' | 'loop' | 'terminal'

const LINE_COLORS = {
  '1í˜¸ì„ (ì‹ ì°½í–‰)':'#0052A4',
  '1í˜¸ì„ (ì¸ì²œí–‰)':'#0052A4',
  '2í˜¸ì„ (ìˆœí™˜ì„ )':'#00A84D',
  '2í˜¸ì„ (ì„±ìˆ˜ì§€ì„ )':'#00A84D',
  '2í˜¸ì„ (ì‹ ì •ì§€ì„ )':'#00A84D',
  '3í˜¸ì„ ':'#EF7C1C',
  '4í˜¸ì„ ':'#00A4E3',
  '5í˜¸ì„ (í•˜ë‚¨ê²€ë‹¨ì‚°í–‰)':'#996CAC',
  '5í˜¸ì„ (ë§ˆì²œí–‰)':'#996CAC',
  '6í˜¸ì„ ':'#CD7C2F',
  '7í˜¸ì„ ':'#747F00',
  '8í˜¸ì„ ':'#EA545D',
  '9í˜¸ì„ ':'#BB8336',
  'ê²½ì˜ì¤‘ì•™ì„ (ë¬¸ì‚°í–‰)':'#77C4A3',
  'ê²½ì˜ì¤‘ì•™ì„ (ì„œìš¸ì—­í–‰)':'#77C4A3',
  'ìˆ˜ì¸ë¶„ë‹¹ì„ ':'#FDA600',
  'ì‹ ë¶„ë‹¹ì„ ':'#D31145',
  'ê²½ì¶˜ì„ ':'#0C8E72',
  'ê³µí•­ì² ë„':'#0090D2',
  'ìš°ì´ì‹ ì„¤ì„ ':'#B7C452',
  'ì‹ ë¦¼ì„ ':'#6789CA',
  'ì„œí•´ì„ ': '#81A64B', // ì„œí•´ì„  ìƒ‰ìƒ ì¶”ê°€
  'ê¹€í¬ê³¨ë“œë¼ì¸': '#A17800', // ê¹€í¬ê³¨ë“œë¼ì¸ ìƒ‰ìƒ ì¶”ê°€
  'ì¸ì²œ1í˜¸ì„ ': '#7CA8D5', // ì¸ì²œ1í˜¸ì„  ìƒ‰ìƒ ì¶”ê°€
  'ì¸ì²œ2í˜¸ì„ ': '#ED8B00', // ì¸ì²œ2í˜¸ì„  ìƒ‰ìƒ ì¶”ê°€
  'ì˜ì •ë¶€': '#FFB200' // ì˜ì •ë¶€ ê²½ì „ì²  ìƒ‰ìƒ ì¶”ê°€
};

// ë©”ì‹œì§€ í…œí”Œë¦¿ (ì ‘ê·¼ì„±/ë‹¤ì–‘ì„±)
const CORRECT_MSGS = [
  'ì •ë‹µ! ë‹¤ìŒ ì—­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.',
  'í›Œë¥­í•´ìš”! ë‹¤ìŒ ì—­ìœ¼ë¡œ ì¶œë°œí•©ë‹ˆë‹¤.',
  'ì¢‹ì•„ìš”! ë‹¤ìŒ ì—­ìœ¼ë¡œ ê°‘ë‹ˆë‹¤.'
];
const WRONG_MSGS = [
  'ë•¡! +3ì´ˆ í˜ë„í‹°',
  'ì•„ì‰½ë„¤ìš” â€” +3ì´ˆê°€ ì¶”ê°€ë©ë‹ˆë‹¤.',
  'í‹€ë ¸ìŠµë‹ˆë‹¤. í˜ë„í‹° +3ì´ˆ'
];
const FINISH_MSGS = {
  timeout: [
    'â° ì œí•œ ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤ â€” ê²Œì„ ì¢…ë£Œ!',
    'ì‹œê°„ ì¢…ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.',
    '1ë¶„ì´ ëë‚¬ìŠµë‹ˆë‹¤. ê¸°ë¡ ì œì¶œ ì¤‘...'
  ],
  loop: [
    'â­• ì¶•í•˜í•©ë‹ˆë‹¤ â€” ìˆœí™˜ì„ ì„ í•œ ë°”í€´ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!',
    'ìˆœí™˜ì„  ì™„ì£¼! ê²Œì„ì„ ì„±ê³µì ìœ¼ë¡œ ë§ˆì³¤ìŠµë‹ˆë‹¤.',
    'í•œ ë°”í€´ ëŒì•˜ì–´ìš”! ì •ë§ ë¹ ë¦…ë‹ˆë‹¤.'
  ],
  terminal: [
    'ğŸ ì¢…ì  ë„ë‹¬! ê²Œì„ ì¢…ë£Œ.',
    'ì¢…ì ê¹Œì§€ ë„ë‹¬í–ˆìŠµë‹ˆë‹¤ â€” ì˜í•˜ì…¨ìŠµë‹ˆë‹¤!',
    'ë§ˆì§€ë§‰ ì—­ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤.'
  ]
};

// util: format ms to mm:ss.cs
function formatTime(ms){
  const total = Math.floor(ms);
  const m = Math.floor(total/60000);
  const s = Math.floor((total%60000)/1000);
  const cs = Math.floor((total%1000)/10);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(cs).padStart(2,'0')}`;
}

// audio
function initAudio(){ if(audioCtx) return; try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; } }
function playSuccess(){ initAudio(); if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.08; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.22); o.stop(audioCtx.currentTime+0.23);}
function playFail(){ initAudio(); if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=220; g.gain.value=0.12; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.35); o.stop(audioCtx.currentTime+0.36);}

// announce helper (ì ‘ê·¼ì„± ë©”ì‹œì§€)
function announceRandom(list){
  const idx = Math.floor(Math.random() * list.length);
  const text = list[idx];
  msgEl.textContent = text;
  // aria-live already set to assertive on #msg
}

// fetch json and structure
// show loading overlay (already visible initially)
fetch(JSON_PATH)
  .then(r => r.ok ? r.json() : Promise.reject('json load failed'))
  .then(data => {
    subwayData = Array.isArray(data) ? buildStructureFromArray(data) : data;
    populateLineSelect();
    // hide loading overlay
    loadingOverlay.style.opacity = '0';
    loadingOverlay.setAttribute('aria-busy','false');
    setTimeout(()=> loadingOverlay.style.display = 'none', 240);
    isDataLoaded = true;
    msgEl.textContent = 'ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”.';
    // enable start after small delay so intro animation finishes nicely
    setTimeout(()=> {
      startBtn.disabled = true; // ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” (ì„ íƒ í•„ìš”)
      updateStartButtonState();
    }, 400);
  })
  .catch(err => {
    console.error(err);
    // show error on overlay
    loadingText.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (json íŒŒì¼ ê²½ë¡œ í™•ì¸)';
    loadingOverlay.style.background = 'rgba(0,0,0,0.6)';
    msgEl.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
    // keep overlay visible so user notices error
  });

function pickStationNames(row){
  const v = row.ì—­ëª… ?? row.station ?? row.name;
  if(!v) return { ko: '', en: '' };
  if(typeof v === 'string') return { ko: v.trim(), en: '' };
  if(typeof v === 'object'){
    return {
      ko: String(v.ko ?? '').trim(),
      en: String(v.en ?? '').trim()
    };
  }
  return { ko: '', en: '' };
}

function buildStructureFromArray(arr){
  const out = {};
  const map = new Map();

  for(const it of arr){
    const region = it.ê¶Œì—­ëª… ?? it.ê¶Œì—­ ?? 'ì „ì²´';
    const line   = it.ë…¸ì„ ëª… ?? it.ë…¸ì„  ?? 'ê¸°íƒ€';
    const key = `${region}|||${line}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  }

  for(const [key, items] of map.entries()){
    const [region, line] = key.split('|||');
    if(!out[region]) out[region] = {};

    const sorted = items.slice().sort((a,b)=> Number(a.ìˆœë²ˆ)-Number(b.ìˆœë²ˆ));
    const names  = [];
    for(const s of sorted){
      const { ko, en } = pickStationNames(s);
      if(ko) names.push({ ko, en });
    }
    out[region][line] = names;
  }
  return out;
}


function populateLineSelect(){
  lineSelect.innerHTML = '';
  const regions = Object.keys(subwayData).sort();
  for(const r of regions){
    const optgroup = document.createElement('optgroup');
    optgroup.label = r;
    const lines = Object.keys(subwayData[r]).sort();
    for(const ln of lines){
      const opt = document.createElement('option');
      opt.value = `${r}|||${ln}`;
      opt.textContent = ln;
      optgroup.appendChild(opt);
    }
    lineSelect.appendChild(optgroup);
  }
  if(lineSelect.options.length>0){
    // ì´ˆê¸° ë…¸ì„  ì„¤ì •ì€ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì„ íƒí•˜ë„ë¡)
  }
}

function setCurrentLine(region, line){
  regionName = region; lineName = line;
  currentLine = (subwayData[region] && subwayData[region][line]) ? subwayData[region][line].slice() : [];
  titleBox.textContent = `${regionName} ${lineName} `;
  // set accent color
  const color = LINE_COLORS[lineName] || '#34E0A1';
  document.documentElement.style.setProperty('--accent', color);
  curDot.style.background = color;
  renderStation();
  renderOptionsPlaceholder();
  updateBest();
  updateStartButtonState();
}

// ì—­ ëª… í‘œì‹œ
function renderStation(){
  if(!currentLine.length){
    prevNameEl.innerHTML = '-';
    curNameEl.innerHTML = 'ì„ íƒëœ ë…¸ì„  ì—†ìŒ';
    nextNameEl.innerHTML = '???';
    return;
  }

  const prevIndex = (currentIndex - 1 + currentLine.length) % currentLine.length;
  const prev = currentLine[prevIndex] ?? null;
  const cur  = currentLine[currentIndex]   ?? null;
  const next = currentLine[(currentIndex + 1) % currentLine.length] ?? null;

  prevNameEl.innerHTML = (prev && started) ? `
    <div class="ko">${prev.ko}</div>
    <div class="en">${prev.en}</div>
  ` : '-';

  curNameEl.innerHTML = cur ? `
    <div class="ko">${cur.ko}</div>
    <div class="en">${cur.en}</div>
  ` : 'ì„ íƒëœ ë…¸ì„  ì—†ìŒ';

  // ê²Œì„ ì¢…ë£Œ ì‹œì  (ì¢…ì )ì—ì„œëŠ” ë‹¤ìŒ ì—­ì„ 'ì¢…ì 'ìœ¼ë¡œ í‘œì‹œ
  let isLastStation = false;
  if (isLoopLine) {
      let endIndex = (startStationIndex - 1 + currentLine.length) % currentLine.length;
      if (currentIndex === endIndex) isLastStation = true;
  } else {
      if (currentIndex === currentLine.length - 1) isLastStation = true;
  }

  nextNameEl.innerHTML = (next && !isLastStation && started) ? `
    <div class="ko">???</div>
    <div class="en">???</div>
  ` : 'ì¢…ì ';
}


// placeholder message while options not filled
function renderOptionsPlaceholder(){ optionsEl.innerHTML = ''; if(!currentLine.length) return; const note = document.createElement('div'); note.style.gridColumn = '1 / -1'; note.style.textAlign='center'; note.style.color='var(--muted)'; note.style.padding='12px'; note.style.fontWeight='700'; note.textContent = 'ê²Œì„ ì‹œì‘ í›„ ì„ íƒì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.'; optionsEl.appendChild(note); }

// timer
function startTimer(){
  cancelTimer();
  startTs = performance.now();
  penaltyMs = 0;
  function loop(){ 
    const elapsed = Math.max(0, performance.now()-startTs+penaltyMs); 
    
    // âœ¨ ì•„ë˜ 5ì¤„ì˜ ì¢…ë£Œ í™•ì¸ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    if (elapsed >= timeLimit && started) {
      finishReason = 'timeout';
      finishTimeAttackMode();
      return; // ë£¨í”„ë¥¼ ë©ˆì¶¥ë‹ˆë‹¤.
    }
    
    timerEl.textContent = formatTime(elapsed); 
    timerRaf = requestAnimationFrame(loop); 
  }
  timerRaf = requestAnimationFrame(loop);
}
function cancelTimer(){ if(timerRaf) cancelAnimationFrame(timerRaf); timerRaf=null; timerEl.textContent = '00:00.00'; }

// Mode selection handlers
mode1Btn.addEventListener('click', ()=>{
  gameMode = 'timeattack';
  mode1Btn.classList.add('selected');
  mode1Btn.setAttribute('aria-pressed','true');
  mode2Btn.classList.remove('selected');
  mode2Btn.setAttribute('aria-pressed','false');
  lineSelectionContainer.style.display = 'block';
  lineSelectionInfo.textContent = 'í”Œë ˆì´í•  ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”';
  populateLineSelectionGrid();
  updateStartButtonState();
});

mode2Btn.addEventListener('click', ()=>{
  gameMode = 'destination';
  mode2Btn.classList.add('selected');
  mode2Btn.setAttribute('aria-pressed','true');
  mode1Btn.classList.remove('selected');
  mode1Btn.setAttribute('aria-pressed','false');
  lineSelectionContainer.style.display = 'block';
  lineSelectionInfo.textContent = 'ì—°ê²°ëœ ë…¸ì„ ë“¤ì„ ì„ íƒí•˜ì„¸ìš” (2ê°œ ì´ìƒ)';
  populateLineSelectionGrid();
  updateStartButtonState();
});

function startGame() {
  if(!isDataLoaded){
    alert('ë°ì´í„° ë¡œë“œê°€ ì•„ì§ ëë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return;
  }

  if(gameMode === 'timeattack') {
    if(selectedLines.length === 0){
      alert('í”Œë ˆì´í•  ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    // ì„ íƒëœ ë…¸ì„ ìœ¼ë¡œ í˜„ì¬ ë…¸ì„  ì„¤ì •
    const [region, line] = selectedLines[0].split('|||');
    setCurrentLine(region, line);
    startTimeAttackMode();
  } else if(gameMode === 'destination') {
    if(selectedLines.length < 2) {
      alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    if(!validateConnectedLines()) {
      alert('ì„ íƒí•œ ë…¸ì„ ë“¤ì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ìŠ¹ì´ ê°€ëŠ¥í•œ ë…¸ì„ ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    startDestinationMode();
  }
}

startBtn.addEventListener('click', startGame);
startGameBtn.addEventListener('click', startGame);

function updateStartButtonState() {
  // ë¡œë”© ì¤‘ì´ë©´ ë¹„í™œì„±í™”
  if(!isDataLoaded){
    startBtn.disabled = true;
    if(startGameBtn) { startGameBtn.disabled=true; startGameBtn.style.opacity='0.5'; }
    if(buttonStatus) buttonStatus.textContent = 'ë°ì´í„° ë¡œë“œ ì¤‘...';
    return;
  }

  if(gameMode === 'timeattack') {
    const shouldEnable = selectedLines.length > 0;
    startBtn.disabled = !shouldEnable;
    if(startGameBtn) {
      startGameBtn.disabled = !shouldEnable;
      startGameBtn.style.opacity = shouldEnable ? '1' : '0.5';
    }
    if(buttonStatus) {
      buttonStatus.textContent = shouldEnable ? 'ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!' : 'ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
    }
  } else if(gameMode === 'destination') {
    const shouldEnable = selectedLines.length >= 2;
    startBtn.disabled = !shouldEnable;
    if(startGameBtn) {
      startGameBtn.disabled = !shouldEnable;
      startGameBtn.style.opacity = shouldEnable ? '1' : '0.5';
    }
    if(buttonStatus) {
      if(selectedLines.length === 0) {
        buttonStatus.textContent = 'ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      } else if(selectedLines.length === 1) {
        buttonStatus.textContent = '2ê°œ ì´ìƒì˜ ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      } else {
        buttonStatus.textContent = 'ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
      }
    }
  }
}

function startTimeAttackMode() {
  // hide intro and show game area
  intro.style.display = 'none';
  document.querySelector('.game-area').style.display = 'flex';

  // ëœë¤ ì‹œì‘ (ë§ˆì§€ë§‰ ì—­ì€ ì œì™¸í•´ì•¼ ë‹¤ìŒ ì—­ì´ ì¡´ì¬)
  currentIndex = Math.floor(Math.random() * currentLine.length);

  // ê²Œì„ ì‹œì‘ ì‹œ ìˆœí™˜ì„  ì—¬ë¶€ì™€ ì‹œì‘ ì¸ë±ìŠ¤ ì„¤ì •
  startStationIndex = currentIndex;
  isLoopLine = (lineName === "2í˜¸ì„ (ìˆœí™˜ì„ )"); // í•„ìš”í•˜ë©´ ë” ë§ì€ ìˆœí™˜ì„  ì´ë¦„ì„ ì¶”ê°€

  // reset moved count
  movedStations = 0;
  window.movedStations = 0;
  finishReason = null;
  started = true;
  msgEl.textContent = `${lineName} íƒ€ì„ì–´íƒ ëª¨ë“œ ì‹œì‘! 1ë¶„ ì•ˆì— ìµœëŒ€í•œ ë©€ë¦¬ ê°€ì„¸ìš”!`;
  renderStation();
  fillOptions();
  startTimer();
  initAudio();
}

function updateSelectedLinesDisplay() {
  const displayEl = document.getElementById('selected-lines-display');
  if (!displayEl) return;

  displayEl.innerHTML = ''; // ë‚´ìš©ì„ ë¹„ì›ë‹ˆë‹¤.

  // 'ëª©ì ì§€ ë„ë‹¬' ëª¨ë“œì´ê³ , ì„ íƒëœ ë…¸ì„ ì´ ìˆì„ ë•Œë§Œ í‘œì‹œí•©ë‹ˆë‹¤.
  if (gameMode === 'destination' && selectedLines.length > 0) {
    selectedLines.forEach(lineKey => {
      const [region, line] = lineKey.split('|||');
      const badge = document.createElement('div');
      badge.className = 'selected-line-badge';
      badge.textContent = line;
      displayEl.appendChild(badge);
    });
  }
}

function populateLineSelectionGrid() {
  lineSelectionGrid.innerHTML = '';
  selectedLines = [];
  updateSelectedLinesDisplay();

  const regions = Object.keys(subwayData).sort();
  for(const region of regions) {
    // ì§€ì—­ë³„ ì„¹ì…˜ í—¤ë” ì¶”ê°€
    const regionHeader = document.createElement('div');
    regionHeader.className = 'region-header';
    regionHeader.textContent = region;
    regionHeader.style.cssText = 'grid-column: 1 / -1; color: #fff; font-weight: 700; font-size: 14px; margin: 16px 0 8px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;';
    lineSelectionGrid.appendChild(regionHeader);

    const lines = Object.keys(subwayData[region]).sort();
    for(const line of lines) {
      const lineBtn = document.createElement('div');
      lineBtn.className = 'line-option';
      lineBtn.textContent = line;
      lineBtn.dataset.region = region;
      lineBtn.dataset.line = line;

      lineBtn.addEventListener('click', () => {
        if(gameMode === 'timeattack') {
          // íƒ€ì„ì–´íƒ ëª¨ë“œ: ë‹¨ì¼ ë…¸ì„  ì„ íƒ
          selectedLines = [`${region}|||${line}`];
          // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ ì„ íƒ í•´ì œ
          document.querySelectorAll('.line-option').forEach(btn => {
            btn.classList.remove('selected');
          });
          lineBtn.classList.add('selected');
        } else {
          // ëª©ì ì§€ ë„ë‹¬ ëª¨ë“œ: ë‹¤ì¤‘ ë…¸ì„  ì„ íƒ
          const key = `${region}|||${line}`;
          if(selectedLines.includes(key)) {
            selectedLines = selectedLines.filter(l => l !== key);
            lineBtn.classList.remove('selected');
          } else {
            selectedLines.push(key);
            lineBtn.classList.add('selected');
          }
        }
        updateSelectedLinesDisplay();
        updateStartButtonState();
      });

      lineSelectionGrid.appendChild(lineBtn);
    }
  }
}



function startDestinationMode() {
  if(selectedLines.length < 2) {
    alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  // ì—°ê²°ëœ ë…¸ì„ ë“¤ì¸ì§€ í™•ì¸ (ê°„ë‹¨í•œ ê²€ì¦)
  if(!validateConnectedLines()) {
    alert('ì„ íƒí•œ ë…¸ì„ ë“¤ì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ìŠ¹ì´ ê°€ëŠ¥í•œ ë…¸ì„ ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  gameMode = 'destination';

  // ëª¨ë“  ì„ íƒëœ ë…¸ì„ ì˜ ì—­ë“¤ì„ í•©ì¹¨
  const allStations = [];
  for(const lineKey of selectedLines) {
    const [region, line] = lineKey.split('|||');
    const stations = subwayData[region][line];
    allStations.push(...stations);
  }

  // ì¤‘ë³µ ì œê±°
  const uniqueStations = [];
  const seen = new Set();
  for(const station of allStations) {
    if(!seen.has(station.ko)) {
      seen.add(station.ko);
      uniqueStations.push(station);
    }
  }

  // ëœë¤ ì¶œë°œì§€ì™€ ëª©ì ì§€ ì„ íƒ
  let startIndex = Math.floor(Math.random() * uniqueStations.length);
  let endIndex = Math.floor(Math.random() * uniqueStations.length);

  // ì¶œë°œì§€ì™€ ëª©ì ì§€ê°€ ê°™ìœ¼ë©´ ë‹¤ì‹œ ì„ íƒ
  while(endIndex === startIndex) {
    endIndex = Math.floor(Math.random() * uniqueStations.length);
  }

  const startStation = uniqueStations[startIndex];
  const endStation = uniqueStations[endIndex];

  // í˜„ì¬ ë…¸ì„ ì„ ì¶œë°œì§€ê°€ ìˆëŠ” ë…¸ì„ ìœ¼ë¡œ ì„¤ì •
  for(const lineKey of selectedLines) {
    const [region, line] = lineKey.split('|||');
    const stations = subwayData[region][line];
    const stationIndex = stations.findIndex(s => s.ko === startStation.ko);
    if(stationIndex !== -1) {
      setCurrentLine(region, line);
      currentIndex = stationIndex;
      destinationStation = endStation;
      break;
    }
  }

  // hide intro and show game area
  intro.style.display = 'none';
  document.querySelector('.game-area').style.display = 'flex';

  // reset move count for destination route
  movedStations = 0;
  window.movedStations = 0;

  started = true;
  msgEl.textContent = `${startStation.ko}ì—ì„œ ${endStation.ko}ê¹Œì§€ ê°€ì„¸ìš”!`;
  renderStation();
  fillOptions();
  startTimer();
  initAudio();
}

function validateConnectedLines() {
  // ê°„ë‹¨í•œ ì—°ê²° ê²€ì¦: ê³µí†µ ì—­ì´ ìˆëŠ”ì§€ í™•ì¸
  if (selectedLines.length < 2) return true;

  const lineStations = selectedLines.map(lineKey => {
      const [region, line] = lineKey.split('|||');
      return new Set(subwayData[region][line].map(s => s.ko));
  });

  const connected = new Set([0]);
  const toCheck = [0];

  while (toCheck.length > 0) {
      const currentIdx = toCheck.pop();
      for (let i = 0; i < lineStations.length; i++) {
          if (i === currentIdx || connected.has(i)) continue;

          const intersection = [...lineStations[currentIdx]].filter(station => lineStations[i].has(station));
          if (intersection.length > 0) {
              if (!connected.has(i)) {
                  connected.add(i);
                  toCheck.push(i);
              }
          }
      }
  }

  return connected.size === lineStations.length;
}


// build options: choose many stations (nearby + random) so it's challenging
function fillOptions(){
  optionsEl.innerHTML = '';
  if(!currentLine.length) return;

  if(gameMode === 'timeattack') {
    // ê¸°ì¡´ íƒ€ì„ì–´íƒ ëª¨ë“œ ê·¸ëŒ€ë¡œ
    const nextIndex = (currentIndex + 1) % currentLine.length;
    const correct = currentLine[nextIndex];
    if(!correct) return;

    const desired = 8;
    const pool = new Set([correct]);

    for(let delta=1; delta<=3; delta++){
      const c1 = currentLine[(nextIndex + delta + currentLine.length) % currentLine.length];
      if (c1) pool.add(c1);
      const c2 = currentLine[(nextIndex - delta + currentLine.length) % currentLine.length];
      if (c2) pool.add(c2);
      if (pool.size >= desired) break;
    }

    const all = Object.values(subwayData).flatMap(reg => Object.values(reg)).flat();
    shuffle(all);
    for(const s of all){
      if(pool.size >= desired) break;
      if(s !== correct && s !== currentLine[currentIndex]) pool.add(s);
    }

    const opts = shuffle(Array.from(pool));
    for(const st of opts){
      const d = document.createElement('div');
      d.className = 'option';
      d.tabIndex = 0;
      d.textContent = st.ko;
      d.dataset.station = st.ko;
      d.addEventListener('click', onOptionClick);
      d.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' ') {
          e.preventDefault();
          onOptionClick({currentTarget:d});
        }
      });
      d.addEventListener('pointerdown', onOptionPointerDown);
      optionsEl.appendChild(d);
    }

  } else if(gameMode === 'destination') {
    const desired = 8;
    const pool = new Set();
    const currentStationName = currentLine[currentIndex].ko;

    // 1. í˜„ì¬ ë…¸ì„ ì—ì„œ ì´ì „/ë‹¤ìŒ ì—­ ì¶”ê°€
    if(currentLine[currentIndex-1]) pool.add(currentLine[currentIndex-1]);
    if(currentLine[currentIndex+1]) pool.add(currentLine[currentIndex+1]);

    // 2. í™˜ìŠ¹ì—­ì´ë©´ í•´ë‹¹ ë…¸ì„ ì˜ ì¸ì ‘ ì—­ ì¶”ê°€
    for(const lineKey of selectedLines) {
      const [region, line] = lineKey.split('|||');
      const stations = subwayData[region][line];
      const idx = stations.findIndex(s => s.ko === currentStationName);
      if (idx > -1) {
        if (stations[idx-1]) pool.add(stations[idx-1]);
        if (stations[idx+1]) pool.add(stations[idx+1]);
      }
    }

    // 3. ëª©ì ì§€ ì¶”ê°€ (ë‹¨, í˜„ì¬ ì—­ê³¼ ì¸ì ‘í•  ë•Œë§Œ)
    if(destinationStation) {
      for(const lineKey of selectedLines) {
        const [region, line] = lineKey.split('|||');
        const stations = subwayData[region][line];
        const idx = stations.findIndex(s => s.ko === currentStationName);
        if (idx > -1) {
          if (stations[idx+1] && stations[idx+1].ko === destinationStation.ko) pool.add(destinationStation);
          if (stations[idx-1] && stations[idx-1].ko === destinationStation.ko) pool.add(destinationStation);
        }
      }
    }

    // 4. ë¶€ì¡±í•˜ë©´ ëœë¤ìœ¼ë¡œ ì±„ìš°ê¸°
    const allSelectedStations = selectedLines.flatMap(lineKey => {
      const [region, line] = lineKey.split('|||');
      return subwayData[region][line];
    });
    shuffle(allSelectedStations);
    for(const station of allSelectedStations) {
      if(pool.size >= desired) break;
      if(station.ko !== currentStationName) pool.add(station);
    }

    const opts = shuffle(Array.from(pool));
    for(const st of opts){
      const d = document.createElement('div');
      d.className = 'option';
      d.tabIndex = 0;
      d.textContent = st.ko;
      d.dataset.station = st.ko;
      d.addEventListener('click', onOptionClick);
      d.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' ') {
          e.preventDefault();
          onOptionClick({currentTarget:d});
        }
      });
      d.addEventListener('pointerdown', onOptionPointerDown);
      optionsEl.appendChild(d);
    }
  }
}


// ë‹¤ìŒ ì—­ìœ¼ë¡œ ì´ë™ ë° ì¢…ë£Œ íŒì •
function moveToNextStation() {
  // ë‹¤ìŒ ì—­ìœ¼ë¡œ ì´ë™ (ìˆœí™˜ ê³ ë ¤)
  currentIndex = (currentIndex + 1) % currentLine.length;

  // ì¦ê°€: ì§€ë‚˜ê°„ ì—­ ìˆ˜
  movedStations++;
  window.movedStations = movedStations;

  if (isLoopLine) {
    // ìˆœí™˜ì„ : ì‹œì‘ì—­ ì§ì „ ì—­ì—ì„œ ì¢…ë£Œ
    let endIndex = (startStationIndex - 1 + currentLine.length) % currentLine.length;
    if (currentIndex === endIndex) {
      finishReason = 'loop';
      renderStation(); // ë§ˆì§€ë§‰ ì—­ì„ ë Œë”ë§
      setTimeout(()=> finishTimeAttackMode(), 120);
      return;
    }
  } else {
    // ì¼ë°˜ì„ : ë§ˆì§€ë§‰ ì—­ì— ë„ë‹¬í•˜ë©´ ì¢…ë£Œ
    if (currentIndex === currentLine.length - 1) {
      finishReason = 'terminal';
      renderStation(); // ë§ˆì§€ë§‰ ì—­ì„ ë Œë”ë§
      setTimeout(()=> finishTimeAttackMode(), 120);
      return;
    }
  }

  // ê²Œì„ì´ ê³„ì†ë˜ë©´ ì—­ê³¼ ì˜µì…˜ ì—…ë°ì´íŠ¸
  renderStation();
  setTimeout(() => {
    fillOptions();
    announceRandom(CORRECT_MSGS);
  }, 240);
}


// option click handler
function onOptionClick(e){
  const el = e.currentTarget;
  const station = el.dataset.station;
  attemptSelect(station, el);
}

// attempt selection (check answer)
function attemptSelect(stationName, domEl){
  if(!started) return;

  if(gameMode === 'timeattack') {
    const correctIndex = (currentIndex + 1) % currentLine.length;
    const correct = currentLine[correctIndex];
    if(!correct) return;

    if(stationName === correct.ko){
      playSuccess();
      domEl.classList.add('correct');
      setTimeout(()=> domEl.classList.remove('correct'), 400);
      moveToNextStation();
    } else {
      playFail();
      domEl.classList.add('wrong');
      setTimeout(()=> domEl.classList.remove('wrong'), 420);
      penaltyMs += 3000;
      announceRandom(WRONG_MSGS);
    }

  } else if(gameMode === 'destination') {
    // ğŸš© ì¢…ì°©ì—­ ì„ íƒ ì‹œ
    if(stationName === destinationStation.ko) {
      let validArrival = false;
      for(const lineKey of selectedLines) {
        const [region, line] = lineKey.split('|||');
        const stations = subwayData[region][line];
        const stationIndex = stations.findIndex(s => s.ko === stationName);
        if(stationIndex !== -1) {
          const currentInThisLineIdx = stations.findIndex(s => s.ko === currentLine[currentIndex].ko);
          if (Math.abs(currentInThisLineIdx - stationIndex) === 1) {
            validArrival = true;
            break;
          }
        }
      }

      if(validArrival) {
        movedStations++;
        window.movedStations = movedStations;
        playSuccess();
        domEl.classList.add('correct');
        setTimeout(()=> domEl.classList.remove('correct'), 400);
        finishDestinationMode();
        return;
      } else {
        playFail();
        domEl.classList.add('wrong');
        setTimeout(()=> domEl.classList.remove('wrong'), 420);
        penaltyMs += 3000;
        announceRandom(WRONG_MSGS);
        return;
      }
    }

    // ğŸš‰ ì¼ë°˜ ì—­ ì„ íƒ ì‹œ
let found = false;
for (const lineKey of selectedLines) {
  const [region, line] = lineKey.split('|||');
  const stations = subwayData[region][line];

  // í˜„ì¬ ì—­ì´ ì´ ë…¸ì„ ì—ë„ ì¡´ì¬í•´ì•¼ í™˜ìŠ¹ ê°€ëŠ¥
  const currentInThisLineIdx = stations.findIndex(
    s => s.ko === currentLine[currentIndex].ko
  );
  if (currentInThisLineIdx === -1) continue; // í˜„ì¬ ì—­ ì—†ìŒ â†’ í™˜ìŠ¹ ë¶ˆê°€

  // ì„ íƒí•œ ì—­ì´ ì´ ë…¸ì„ ì— ìˆëŠ”ì§€ í™•ì¸
  const stationIndex = stations.findIndex(s => s.ko === stationName);
  if (stationIndex === -1) continue;

  // âœ… ì¸ì ‘ ì—­ë§Œ ì´ë™ í—ˆìš©
  if (Math.abs(currentInThisLineIdx - stationIndex) === 1) {
    playSuccess();
    domEl.classList.add('correct');
    setTimeout(() => domEl.classList.remove('correct'), 400);

    movedStations++;
    window.movedStations = movedStations;

    // í™˜ìŠ¹ ì‹œ ë…¸ì„  ë³€ê²½
    currentLine = stations;
    lineName = line;
    regionName = region;
    currentIndex = stationIndex;

    found = true;
    break;
    }
  }
    if(found) {
      renderStation();
      setTimeout(()=>{
        fillOptions();
        msgEl.textContent = `${destinationStation.ko}ê¹Œì§€ ê³„ì† ê°€ì„¸ìš”!`;
      }, 240);
    } else {
      playFail();
      domEl.classList.add('wrong');
      setTimeout(() => domEl.classList.remove('wrong'), 420);
      penaltyMs += 3000;
      announceRandom(WRONG_MSGS);
    }
  }
}



// finish functions for different modes
function finishTimeAttackMode(){
  if (!started) {
    // ì´ë¯¸ ì¢…ë£Œëì„ ë•Œ ì¤‘ë³µ ë°©ì§€
    return;
  }
  started = false;
  cancelTimer();
  if(timeLimitTimer){ clearTimeout(timeLimitTimer); timeLimitTimer = null; }
  const elapsed = Math.max(0, performance.now()-startTs+penaltyMs);

  // ì‚¬ìš©ìê°€ ìš”ì²­í•œ ê¸°ì¤€: ë¦¬ë”ë³´ë“œ ì œì¶œì€ 'ì§€ë‚˜ê°„ ì—­ ìˆ˜'
  const distance = movedStations;

  // ì¢…ë£Œ ì´ìœ  ê²°ì •
  const reason = finishReason || 'timeout';

  // ë‹¤ì–‘í•œ ë©˜íŠ¸ ì¤‘ ëœë¤ìœ¼ë¡œ ì„ íƒ
  const lines = FINISH_MSGS[reason] || FINISH_MSGS.timeout;
  const text = lines[Math.floor(Math.random()*lines.length)];

  // ìƒì„¸ ë©”ì‹œì§€ í‘œì‹œ
  msgEl.textContent = `${text} ${distance}ê°œ ì—­ì„ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤. ê¸°ë¡: ${formatTime(elapsed)}`;

  // ë¡œì»¬ ìµœê³ ê±°ë¦¬ ì €ì¥ (TimeAttackì€ 'ë§ì„ìˆ˜ë¡ ì¢‹ìŒ')
  saveBestDistance(distance);

  // show message in options area
  optionsEl.innerHTML = '';
  const n = document.createElement('div');
  n.style.gridColumn='1 / -1';
  n.style.textAlign='center';
  n.style.fontWeight=800;
  n.style.padding='18px';
  n.innerHTML = `${text}<br>${distance}ê°œ ì—­ì„ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ë…¸ì„ ì— ë„ì „í•˜ì„¸ìš”!`;
  optionsEl.appendChild(n);

  // Add restart button
  const restartBtn = document.createElement('button');
  restartBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
  restartBtn.style.cssText = 'background:linear-gradient(135deg,#00ffcc,#00d4a3); color:#001a0f; padding:12px 24px; border-radius:12px; border:0; font-weight:800; cursor:pointer; font-size:16px; margin-top:16px; box-shadow:0 8px 24px rgba(0,255,204,0.3); transition:all 0.3s ease;';
  restartBtn.addEventListener('click', () => {
    document.querySelector('.game-area').style.display = 'none';
    intro.style.display = 'flex';
    // Reset selections
    selectedLines = [];
    lineSelectionContainer.style.display = 'none';
    movedStations = 0;
    window.movedStations = 0;
    updateStartButtonState();
  });
  n.appendChild(restartBtn);

  const retryBtn = document.createElement('button');
  retryBtn.textContent = 'ê°™ì€ ì¡°ê±´ìœ¼ë¡œ ì¬ì‹œë„';
  retryBtn.style.cssText = restartBtn.style.cssText + 'margin-left: 12px; background: linear-gradient(135deg, #89f7fe, #66a6ff);';
  retryBtn.addEventListener('click', () => {
    // ì¬ì‹œë„: ê°™ì€ ë…¸ì„  / ê°™ì€ ëª¨ë“œ
    startGame();
  });
  n.appendChild(retryBtn);

  playSuccess();
}

function finishDestinationMode(){
  if(!started) return;
  started = false;
  cancelTimer();
  const elapsed = Math.max(0, performance.now()-startTs+penaltyMs);
  const distance = movedStations;

  // ë©”ì‹œì§€
  msgEl.textContent = `ğŸ¯ ëª©ì ì§€ ë„ë‹¬! ${distance}ê°œ ì´ë™. ê¸°ë¡: ${formatTime(elapsed)}`;

  // ëª©ì ì§€ ëª¨ë“œëŠ” ì‹œê°„ ê¸°ë°˜ ìµœê³ ê¸°ë¡ ì €ì¥(ì§§ì„ìˆ˜ë¡ ì¢‹ìŒ)
  saveBestTime(elapsed);

  // show message in options area
  optionsEl.innerHTML = '';
  const n = document.createElement('div');
  n.style.gridColumn='1 / -1';
  n.style.textAlign='center';
  n.style.fontWeight=800;
  n.style.padding='18px';
  n.innerHTML = `ëª©ì ì§€ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!<br>${destinationStation.ko}ê¹Œì§€ ${formatTime(elapsed)}ë§Œì— ë„ì°©! (ì´ë™: ${distance}íšŒ)<br>ë‹¤ë¥¸ ê²½ë¡œì— ë„ì „í•˜ì„¸ìš”!`;
  optionsEl.appendChild(n);

  // Add restart button
  const restartBtn = document.createElement('button');
  restartBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
  restartBtn.style.cssText = 'background:linear-gradient(135deg,#00ffcc,#00d4a3); color:#001a0f; padding:12px 24px; border-radius:12px; border:0; font-weight:800; cursor:pointer; font-size:16px; margin-top:16px; box-shadow:0 8px 24px rgba(0,255,204,0.3); transition:all 0.3s ease;';
  restartBtn.addEventListener('click', () => {
    document.querySelector('.game-area').style.display = 'none';
    intro.style.display = 'flex';
    // Reset selections
    selectedLines = [];
    lineSelectionContainer.style.display = 'none';
    movedStations = 0;
    window.movedStations = 0;
    updateStartButtonState();
  });
  n.appendChild(restartBtn);

  const retryBtn = document.createElement('button');
  retryBtn.textContent = 'ê°™ì€ ì¡°ê±´ìœ¼ë¡œ ì¬ì‹œë„';
  retryBtn.style.cssText = restartBtn.style.cssText + 'margin-left: 12px; background: linear-gradient(135deg, #89f7fe, #66a6ff);';
  retryBtn.addEventListener('click', () => {
    startGame();
  });
  n.appendChild(retryBtn);

  playSuccess();
}

// Legacy function for backward compatibility
function finishGame(){
  if(gameMode === 'timeattack') {
    finishTimeAttackMode();
  } else if(gameMode === 'destination') {
    finishDestinationMode();
  }
}

// ==== Best / local storage helpers ====
// For TimeAttack we store best *distance* (max)
// For Destination we store best *time* (min)
function saveBestDistance(dist){
  const k = `speed_subway_timeattack_maxdist__${regionName}__${lineName}`;
  const prev = Number(localStorage.getItem(k) || 0);
  if(dist > prev){
    localStorage.setItem(k, String(dist));
  }
  updateBest();
}
function saveBestTime(ms){
  const k = `speed_subway_destination__${selectedLines.join('_')}`;
  const prev = localStorage.getItem(k);
  if(!prev || ms < Number(prev)){
    localStorage.setItem(k, String(Math.floor(ms)));
  }
  updateBest();
}

function updateBest(){
  if(gameMode === 'timeattack'){
    const k = `speed_subway_timeattack_maxdist__${regionName}__${lineName}`;
    const v = localStorage.getItem(k);
    bestEl.textContent = v ? `íƒ€ì„ì–´íƒ ìµœê³ ê±°ë¦¬: ${v} ì—­` : 'íƒ€ì„ì–´íƒ ìµœê³ ê±°ë¦¬: -';
  } else if(gameMode === 'destination'){
    const k = `speed_subway_destination__${selectedLines.join('_')}`;
    const v = localStorage.getItem(k);
    bestEl.textContent = v ? `ëª©ì ì§€ ë„ë‹¬ ìµœê³ ê¸°ë¡: ${formatTime(Number(v))}` : 'ëª©ì ì§€ ë„ë‹¬ ìµœê³ ê¸°ë¡: -';
  } else {
    bestEl.textContent = '-';
  }
}

// simple helpers
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]] = [arr[j],arr[i]]; } return arr; }

// pointer drag basic visual (not necessary but friendly)
let dragState = null;
function onOptionPointerDown(e){
  const target = e.currentTarget;
  target.setPointerCapture(e.pointerId);
  target.classList.add('dragging');
  function end(ev){
    try{ target.releasePointerCapture(e.pointerId);}catch(_){}
    target.classList.remove('dragging');
    target.removeEventListener('pointerup', end);
    target.removeEventListener('pointercancel', end);
    // check drop on current card area (we allow drop by checking clientX/clientY vs currentCard)
    const rect = document.getElementById('currentCard').getBoundingClientRect();
    if(ev.clientX >= rect.left && ev.clientX <= rect.right && ev.clientY >= rect.top && ev.clientY <= rect.bottom){
      // treat as selection of that option
      attemptSelect(target.dataset.station, target);
    }
  }
  target.addEventListener('pointerup', end);
  target.addEventListener('pointercancel', end);
}

// safety: disable start until json loaded
startBtn.disabled = true;

</script>
<script type="module">
  /**
   * ì•±ì¸í† ìŠ¤ ì›¹ í”„ë ˆì„ì›Œí¬ ì—°ë™ (game ê°€ì´ë“œ ëŒ€ì‘)
   * - Safe area íŒ¨ë”©
   * - ë’¤ë¡œê°€ê¸°/ë‹«ê¸°(X) í™•ì¸
   * - ë¦¬ë”ë³´ë“œ ì œì¶œ/ì—´ê¸°
   * - ì ‘ê·¼ì„± ë©”ì‹œì§€ ë³´ê°•
   */
  import {
    getSafeAreaInsets,
    bedrockEvent,
    openGameCenterLeaderboard,
    submitGameCenterLeaderBoardScore,
  } from '@apps-in-toss/web-framework';

  /* ---------------------------
   * Safe Area (ë…¸ì¹˜/í™ˆ ì¸ë””ì¼€ì´í„°) ëŒ€ì‘
   * --------------------------- */
  try {
    const insets = getSafeAreaInsets();
    document.documentElement.style.setProperty('--safe-top', `${insets.top || 0}px`);
    document.documentElement.style.setProperty('--safe-bottom', `${insets.bottom || 0}px`);
    const topbar = document.querySelector('.topbar');
    if (topbar) topbar.style.paddingTop = `calc(${insets.top || 0}px + 16px)`;
    const gameArea = document.querySelector('.game-area');
    if (gameArea) gameArea.style.paddingBottom = `calc(${insets.bottom || 0}px + 16px)`;
  } catch (_) {}

  /* ---------------------------
   * ë’¤ë¡œê°€ê¸° ì²˜ë¦¬
   * --------------------------- */
  try {
    bedrockEvent.addEventListener('backEvent', {
      onEvent: () => {
        const ok = confirm('ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ì¤‘ì¸ ê¸°ë¡ì€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        if (ok) {
          window.close();
        }
      },
    });
  } catch (_) {}

  /* ---------------------------
   * ì ‘ê·¼ì„± ë³´ê°•: aria-live ì˜ì—­ ë³´ì¥
   * --------------------------- */
  (() => {
    let live = document.getElementById('msg');
    if (!live) {
      live = document.createElement('div');
      live.id = 'msg';
      document.body.appendChild(live);
    }
    live.setAttribute('aria-live', 'assertive');
  })();

  /* ---------------------------
   * ë¦¬ë”ë³´ë“œ ì—°ë™
   * - submit with movedStations (distance)
   * --------------------------- */
  const LB_IDS = {
    timeattack: 'timeattack-score',
    destination: 'destination-score',
  };

  function patchFinish(name, wrap) {
    const prev = window[name];
    if (typeof prev === 'function') {
      window[name] = function patched(...args) {
        try {
          wrap(...args);
        } catch (e) {
          console.warn(`[apps-in-toss] ${name} wrapper error`, e);
        }
        return prev.apply(this, args);
      };
    }
  }

  async function submitLeaderboardSafe({ mode, score }) {
    if (score == null || score < 0) return;
    const leaderboardId = LB_IDS[mode];
    if (!leaderboardId) return;
    try {
      await submitGameCenterLeaderBoardScore({
        leaderboardId,
        score: Math.floor(score), // ì •ìˆ˜
      });
    } catch (e) {
      console.warn('[apps-in-toss] submit leaderboard failed', e);
    }
  }

  // finishTimeAttackMode íŒ¨ì¹˜: elapsed ëŒ€ì‹  movedStations ì œì¶œ
  patchFinish('finishTimeAttackMode', () => {
    try {
      const score = window.movedStations || 0;
      submitLeaderboardSafe({ mode: 'timeattack', score });
    } catch (e) { console.warn(e); }
  });

  // finishDestinationMode íŒ¨ì¹˜: ëª©ì ì§€ ëª¨ë“œì—ì„œë„ ì´ë™ íšŸìˆ˜ë¡œ ì œì¶œ (ìš”ì²­ëŒ€ë¡œ)
  patchFinish('finishDestinationMode', () => {
    try {
      const score = window.movedStations || 0;
      submitLeaderboardSafe({ mode: 'destination', score });
    } catch (e) { console.warn(e); }
  });

  // finishGame íŒ¨ì¹˜ (í˜¸í™˜ì„±)
  patchFinish('finishGame', () => {
    try {
      const score = window.movedStations || 0;
      const mode = (window.gameMode === 'destination') ? 'destination' : 'timeattack';
      submitLeaderboardSafe({ mode, score });
    } catch (e) { console.warn(e); }
  });

  /* ---------------------------
   * ë¦¬ë”ë³´ë“œ ì—´ê¸° ë²„íŠ¼
   * --------------------------- */
  (() => {
    if (document.getElementById('leaderboardBtn')) return;

    const topbar = document.querySelector('.topbar');
    if (!topbar) return;

    const btn = document.createElement('button');
    btn.id = 'leaderboardBtn';
    btn.textContent = 'ë¦¬ë”ë³´ë“œ';
    btn.style.cssText = `
      margin-left: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 0;
      font-weight: 800;
      cursor: pointer;
    `;
    btn.addEventListener('click', () => {
      const mode = (window.gameMode === 'destination') ? 'destination' : 'timeattack';
      const leaderboardId = LB_IDS[mode];
      if (!leaderboardId) return;
      try {
        openGameCenterLeaderboard({ leaderboardId });
      } catch (e) {
        console.warn('[apps-in-toss] open leaderboard failed', e);
        alert('ì•±ì—ì„œë§Œ ë¦¬ë”ë³´ë“œë¥¼ ì—´ ìˆ˜ ìˆì–´ìš”.');
      }
    });

    const rightBox = document.createElement('div');
    rightBox.style.display = 'flex';
    rightBox.style.alignItems = 'center';
    rightBox.appendChild(btn);

    const timerBox = topbar.querySelector('.timer-box');
    if (timerBox?.parentElement === topbar) {
      timerBox.after(rightBox);
    } else {
      topbar.appendChild(rightBox);
    }
  })();
  </script>
</body>
</html>